{% extends 'base.html' %}
{% load static %}

{% block title %}Profile - IGS OP{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1><i class="fas fa-user-circle"></i> MY PROFILE</h1>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="profile-grid">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="profile-avatar">
                    {% else %}
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    {% endif %}
                    
                    <h2>{{ user.username }}</h2>
                    <p class="profile-id">ID: {{ user.user_id }}</p>
                    
                    <a href="{% url 'profile_edit' %}" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Edit Profile
                    </a>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card balance-card">
                        <i class="fas fa-coins"></i>
                        <h3>{{ user.coins }}</h3>
                        <p>Coins Balance</p>
                        <div class="balance-actions">
                            <a href="{% url 'buy_coins' %}" class="btn-mini btn-primary">
                                <i class="fas fa-plus"></i> Add Coins
                            </a>
                            <a href="{% url 'request_withdrawal' %}" class="btn-mini btn-success">
                                <i class="fas fa-money-bill-wave"></i> Withdraw
                            </a>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-trophy"></i>
                        <h3>{{ user.total_tournaments_won }}</h3>
                        <p>Tournaments Won</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-gamepad"></i>
                        <h3>{{ user.total_tournaments_played }}</h3>
                        <p>Tournaments Played</p>
                    </div>
                    
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3>{{ referral_count }}</h3>
                        <p>Referrals</p>
                    </div>
                </div>
                
                <div class="profile-info">
                    <h3><i class="fas fa-info-circle"></i> Account Details</h3>
                    
                    <div class="info-row">
                        <strong><i class="fas fa-envelope"></i> Email:</strong>
                        <span>{{ user.email }}</span>
                    </div>
                    
                    {% if user.phone %}
                        <div class="info-row">
                            <strong><i class="fas fa-phone"></i> Phone:</strong>
                            <span>{{ user.phone }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="info-row">
                        <strong><i class="fas fa-calendar"></i> Member Since:</strong>
                        <span>{{ user.date_joined|date:"M d, Y" }}</span>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3><i class="fas fa-gift"></i> Referral Code</h3>
                    <div class="referral-code">
                        <code id="referralCode">{{ user.referral_code }}</code>
                        <button class="btn btn-secondary btn-sm" onclick="copyReferralCode()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <p class="text-muted">Share this code and earn 10 coins per referral!</p>
                </div>
            </div>
            
            <!-- Created Tournaments -->
            {% if created_tournaments %}
            <div class="profile-content full-width">
                <div class="detail-card">
                    <h3><i class="fas fa-plus-circle"></i> My Created Matches</h3>
                    
                    <div class="created-tournaments-grid">
                        {% for tournament in created_tournaments %}
                            <div class="created-tournament-card {% if tournament.current_participants >= 2 %}match-ready{% endif %}">
                                <!-- Tournament Image -->
                                <div class="created-tournament-image">
                                    {% if tournament.image %}
                                        <img src="{{ tournament.image.url }}" alt="{{ tournament.title }}">
                                    {% else %}
                                        {% if tournament.game == 'freefire' %}
                                            <img src="{% static 'images/freefire-icon.png' %}" alt="Free Fire" class="default-game-icon">
                                        {% elif tournament.game == 'pubg' %}
                                            <img src="{% static 'images/pubg-icon.png' %}" alt="PUBG" class="default-game-icon">
                                        {% else %}
                                            <div class="created-placeholder">
                                                <i class="fas fa-trophy fa-2x"></i>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- Status Badge Overlay -->
                                    <div class="match-status-badge {% if tournament.current_participants >= 2 %}ready{% else %}waiting{% endif %}">
                                        {% if tournament.current_participants >= 2 %}
                                            <i class="fas fa-check-circle"></i> Match Ready
                                        {% else %}
                                            <i class="fas fa-clock"></i> Waiting
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Tournament Info -->
                                <div class="created-tournament-info">
                                    <h4 class="created-tournament-title">{{ tournament.title }}</h4>
                                    
                                    <div class="created-meta">
                                        <span><i class="fas fa-gamepad"></i> {{ tournament.get_game_display }}</span>
                                        <span><i class="fas fa-users"></i> {{ tournament.current_participants }}/{{ tournament.max_participants }}</span>
                                    </div>
                                    
                                    <div class="created-time">
                                        <i class="fas fa-clock"></i>
                                        {{ tournament.tournament_date|date:"d M, g:i A" }}
                                    </div>
                                    
                                    <div class="created-rewards">
                                        <i class="fas fa-coins"></i>
                                        <strong>{{ tournament.prize_pool }} Points</strong> Prize
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="created-actions">
                                        {% if tournament.current_participants >= 2 %}
                                            <a href="{% url 'set_room_details' tournament.pk %}" class="btn btn-success btn-sm btn-block">
                                                <i class="fas fa-door-open"></i> Set Room Details
                                            </a>
                                        {% endif %}
                                        
                                        <div class="action-row">
                                            <a href="{% url 'tournament_detail' tournament.pk %}" class="btn btn-primary btn-sm">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            <a href="{% url 'delete_tournament' tournament.pk %}" class="btn btn-danger btn-sm" 
                                               onclick="return confirm('Are you sure you want to delete this match? This will cancel the match for all participants.')">
                                                <i class="fas fa-trash"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Tournament History -->
            <div class="profile-content">
                <div class="detail-card">
                    <h3><i class="fas fa-history"></i> Tournament History</h3>
                    
                    <div class="history-list">
                        {% for participation in tournament_history %}
                            <div class="history-item">
                                <div class="history-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                
                                <div class="history-info">
                                    <h4>{{ participation.tournament.title }}</h4>
                                    <p>{{ participation.tournament.get_game_display }} • {{ participation.joined_at|date:"M d, Y" }}</p>
                                    
                                    {% if participation.position %}
                                        <span class="position-badge">
                                            <i class="fas fa-medal"></i> Position: #{{ participation.position }}
                                        </span>
                                    {% endif %}
                                    
                                    {% if participation.prize_won > 0 %}
                                        <span class="prize-badge">
                                            <i class="fas fa-coins"></i> Won: {{ participation.prize_won }} Coins
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <a href="{% url 'tournament_detail' participation.tournament.pk %}" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </div>
                        {% empty %}
                            <p class="text-muted">No tournament history yet</p>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="detail-card">
                    <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                    
                    <div class="transactions-list">
                        {% for transaction in recent_transactions %}
                            <div class="transaction-item small">
                                <div class="transaction-icon {% if transaction.amount > 0 %}positive{% else %}negative{% endif %}">
                                    {% if transaction.transaction_type == 'deposit' %}
                                        <i class="fas fa-arrow-down"></i>
                                    {% elif transaction.transaction_type == 'tournament_win' %}
                                        <i class="fas fa-trophy"></i>
                                    {% elif transaction.transaction_type == 'withdrawal' %}
                                        <i class="fas fa-money-bill-wave"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-up"></i>
                                    {% endif %}
                                </div>
                                
                                <div class="transaction-info">
                                    <h4>{{ transaction.get_transaction_type_display }}</h4>
                                    <small>{{ transaction.created_at|date:"M d, Y" }}</small>
                                </div>
                                
                                <div class="transaction-amount {% if transaction.amount > 0 %}positive{% else %}negative{% endif %}">
                                    {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount }}
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">No transactions yet</p>
                        {% endfor %}
                    </div>
                    
                    <a href="{% url 'wallet' %}" class="btn btn-secondary btn-block">
                        <i class="fas fa-eye"></i> View All Transactions
                    </a>
                </div>

                <div class="detail-card">
                    <h3><i class="fas fa-money-bill-wave"></i> Withdrawal Requests</h3>
                    
                    <div class="withdrawals-list">
                        {% for withdrawal in withdrawal_requests %}
                            <div class="withdrawal-item">
                                <div class="withdrawal-icon status-{{ withdrawal.status }}">
                                    {% if withdrawal.status == 'pending' %}
                                        <i class="fas fa-clock"></i>
                                    {% elif withdrawal.status == 'approved' %}
                                        <i class="fas fa-check-circle"></i>
                                    {% else %}
                                        <i class="fas fa-times-circle"></i>
                                    {% endif %}
                                </div>
                                
                                <div class="withdrawal-info">
                                    <h4>{{ withdrawal.amount }} Points</h4>
                                    <small>{{ withdrawal.payment_method }} • {{ withdrawal.created_at|date:"M d, Y" }}</small>
                                    {% if withdrawal.admin_notes %}
                                        <div class="admin-notes">{{ withdrawal.admin_notes }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="withdrawal-status status-{{ withdrawal.status }}">
                                    {{ withdrawal.get_status_display }}
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">No withdrawal requests yet</p>
                        {% endfor %}
                    </div>
                    
                    <a href="{% url 'request_withdrawal' %}" class="btn btn-primary btn-block">
                        <i class="fas fa-money-bill-wave"></i> Request Withdrawal
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

{% block extra_css %}
<style>
/* Balance card enhancements */
.balance-card {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    overflow: hidden;
}

.balance-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: rotate(45deg);
}

.balance-card i {
    color: rgba(255, 255, 255, 0.9);
}

.balance-card h3, .balance-card p {
    color: white;
    position: relative;
    z-index: 2;
}

.balance-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    position: relative;
    z-index: 2;
}

.btn-mini {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    text-decoration: none;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

.btn-mini.btn-primary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.btn-mini.btn-success {
    background: rgba(16, 185, 129, 0.8);
    color: white;
    border-color: rgba(16, 185, 129, 0.5);
}

.btn-mini:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Withdrawal items */
.withdrawals-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.withdrawal-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.withdrawal-item:hover {
    background: #f1f5f9;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.withdrawal-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.withdrawal-icon.status-pending {
    background: #fef3c7;
    color: #d97706;
}

.withdrawal-icon.status-approved {
    background: #dcfce7;
    color: #059669;
}

.withdrawal-icon.status-rejected {
    background: #fee2e2;
    color: #dc2626;
}

.withdrawal-info {
    flex: 1;
}

.withdrawal-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.withdrawal-info small {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.admin-notes {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #e0e7ff;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #3730a3;
}

.withdrawal-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.withdrawal-status.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.withdrawal-status.status-approved {
    background: #dcfce7;
    color: #065f46;
}

.withdrawal-status.status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .balance-actions {
        flex-direction: column;
    }
    
    .btn-mini {
        justify-content: center;
    }
    
    .withdrawal-item {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
    }
    
    .withdrawal-info {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function copyReferralCode() {
    const code = document.getElementById('referralCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        alert('Referral code copied to clipboard!');
    });
}
</script>
{% endblock %}
{% endblock %}
